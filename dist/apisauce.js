'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.responseToProblem = exports.create = exports.UNKNOWN_ERROR = exports.NETWORK_ERROR = exports.CONNECTION_ERROR = exports.TIMEOUT_ERROR = exports.SERVER_ERROR = exports.CLIENT_ERROR = exports.NONE = undefined;

var _axios = require('axios');

var _axios2 = _interopRequireDefault(_axios);

var _ramda = require('ramda');

var _ramda2 = _interopRequireDefault(_ramda);

var _ramdasauce = require('ramdasauce');

var _ramdasauce2 = _interopRequireDefault(_ramdasauce);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// check for an invalid config
var isInvalidConfig = _ramda2.default.anyPass([_ramda2.default.isNil, _ramda2.default.isEmpty, _ramda2.default.complement(_ramda2.default.has('baseURL')), _ramda2.default.complement(_ramda2.default.propIs(String, 'baseURL')), _ramda2.default.propSatisfies(_ramda2.default.isEmpty, 'baseURL')]);

// the default configuration for axios
var DEFAULT_CONFIG = {
  timeout: 0,
  headers: {}
};

var NONE = null;
var CLIENT_ERROR = 'CLIENT_ERROR';
var SERVER_ERROR = 'SERVER_ERROR';
var TIMEOUT_ERROR = 'TIMEOUT_ERROR';
var CONNECTION_ERROR = 'CONNECTION_ERROR';
var NETWORK_ERROR = 'NETWORK_ERROR';
var UNKNOWN_ERROR = 'UNKNOWN_ERROR';

var TIMEOUT_ERROR_CODES = ['ECONNABORTED'];
var NODEJS_CONNECTION_ERROR_CODES = ['ENOTFOUND', 'ECONNREFUSED', 'ECONNRESET'];
var in200s = _ramdasauce2.default.isWithin(200, 299);
var in400s = _ramdasauce2.default.isWithin(400, 499);
var in500s = _ramdasauce2.default.isWithin(500, 599);

/**
  Creates a instance of our API using the configuration.
 */
var create = function create(config) {
  // quick sanity check
  if (isInvalidConfig(config)) throw new Error('config must have a baseURL');

  // combine the user's defaults with ours
  var combinedConfig = _ramda2.default.merge(DEFAULT_CONFIG, config);

  // create the axios instance
  var instance = _axios2.default.create(combinedConfig);
  var monitors = [];
  var addMonitor = function addMonitor(monitor) {
    monitors.push(monitor);
  };

  // create the base object
  var sauce = {
    axiosInstance: instance,
    monitors: monitors,
    addMonitor: addMonitor
  };

  // attach functions for each our HTTP verbs
  sauce.get = _ramda2.default.partial(doRequestWithoutBody, [sauce, 'get']);
  sauce.delete = _ramda2.default.partial(doRequestWithoutBody, [sauce, 'delete']);
  sauce.head = _ramda2.default.partial(doRequestWithoutBody, [sauce, 'head']);
  sauce.post = _ramda2.default.partial(doRequestWithBody, [sauce, 'post']);
  sauce.call = _ramda2.default.partial(doRequestWithoutBody, [sauce, 'post']);
  sauce.put = _ramda2.default.partial(doRequestWithBody, [sauce, 'put']);
  sauce.patch = _ramda2.default.partial(doRequestWithBody, [sauce, 'patch']);

  // send it back
  return sauce;
};

/**
  Make the request for GET, HEAD, DELETE
 */
var doRequestWithoutBody = function doRequestWithoutBody(api, method, url) {
  var params = arguments.length <= 3 || arguments[3] === undefined ? {} : arguments[3];
  var axiosConfig = arguments.length <= 4 || arguments[4] === undefined ? {} : arguments[4];

  return doRequest(api, _ramda2.default.merge({ url: url, params: params, method: method }, axiosConfig));
};

/**
  Make the request for POST, PUT, PATCH
 */
var doRequestWithBody = function doRequestWithBody(api, method, url) {
  var data = arguments.length <= 3 || arguments[3] === undefined ? null : arguments[3];
  var axiosConfig = arguments.length <= 4 || arguments[4] === undefined ? {} : arguments[4];

  return doRequest(api, _ramda2.default.merge({ url: url, method: method, data: data }, axiosConfig));
};

/**
  Make the request with this config!
 */
var doRequest = function doRequest(api, axiosRequestConfig) {
  var axiosInstance = api.axiosInstance;

  var startedAt = _ramdasauce2.default.toNumber(new Date());

  // first convert the axios response, then execute our callback
  var chain = _ramda2.default.pipe(_ramda2.default.partial(convertResponse, [startedAt]), _ramda2.default.partial(runMonitors, [api]));

  // Make the request and execute the identical pipeline for both promise paths.
  return axiosInstance.request(axiosRequestConfig).then(chain).catch(chain);
};

/**
  Fires after we convert from axios' response into our response.  Exceptions
  raised for each monitor will be ignored.
 */
var runMonitors = function runMonitors(api, ourResponse) {
  api.monitors.forEach(function (fn) {
    try {
      fn(ourResponse);
    } catch (error) {
      // all monitor complaints will be ignored
    }
  });
  return ourResponse;
};

/**
  Converts an axios response/error into our response.
 */
var convertResponse = function convertResponse(startedAt, axiosResponse) {
  var end = _ramdasauce2.default.toNumber(new Date());
  var duration = end - startedAt;
  return {
    duration: duration,
    problem: responseToProblem(axiosResponse),
    ok: _ramda2.default.pipe(_ramda2.default.propOr(0, 'status'), in200s)(axiosResponse),
    status: axiosResponse.status || null,
    headers: axiosResponse.headers || null,
    config: axiosResponse.config || null,
    data: axiosResponse.data || null
  };
};

/**
  What's the problem for this response?

  TODO: We're losing some error granularity, but i'm cool with that
  until someone cares.
 */
var responseToProblem = function responseToProblem(response) {
  if (response instanceof Error) {
    return _ramda2.default.cond([[_ramda2.default.contains(_ramda2.default.__, TIMEOUT_ERROR_CODES), _ramda2.default.always(TIMEOUT_ERROR)], [_ramda2.default.contains(_ramda2.default.__, NODEJS_CONNECTION_ERROR_CODES), _ramda2.default.always(CONNECTION_ERROR)], [_ramda2.default.T, _ramda2.default.always(UNKNOWN_ERROR)]])(response.code);
  }
  if (_ramda2.default.isNil(response) || !_ramda2.default.has('status')) return UNKNOWN_ERROR;
  return _ramda2.default.cond([[in200s, _ramda2.default.always(NONE)], [in400s, _ramda2.default.always(CLIENT_ERROR)], [in500s, _ramda2.default.always(SERVER_ERROR)], [_ramda2.default.T, _ramda2.default.always(UNKNOWN_ERROR)]])(response.status || 0);
};

module.exports = {
  responseToProblem: responseToProblem,
  create: create,
  NONE: NONE,
  CLIENT_ERROR: CLIENT_ERROR,
  SERVER_ERROR: SERVER_ERROR,
  TIMEOUT_ERROR: TIMEOUT_ERROR,
  CONNECTION_ERROR: CONNECTION_ERROR,
  NETWORK_ERROR: NETWORK_ERROR,
  UNKNOWN_ERROR: UNKNOWN_ERROR
};

exports.NONE = NONE;
exports.CLIENT_ERROR = CLIENT_ERROR;
exports.SERVER_ERROR = SERVER_ERROR;
exports.TIMEOUT_ERROR = TIMEOUT_ERROR;
exports.CONNECTION_ERROR = CONNECTION_ERROR;
exports.NETWORK_ERROR = NETWORK_ERROR;
exports.UNKNOWN_ERROR = UNKNOWN_ERROR;
exports.create = create;
exports.responseToProblem = responseToProblem;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwaXNhdWNlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7OztBQUNBOzs7O0FBQ0E7Ozs7OztBQUVBO0FBQ0EsSUFBTSxrQkFBa0IsZ0JBQUUsT0FBRixDQUFVLENBQ2hDLGdCQUFFLEtBRDhCLEVBRWhDLGdCQUFFLE9BRjhCLEVBR2hDLGdCQUFFLFVBQUYsQ0FBYSxnQkFBRSxHQUFGLENBQU0sU0FBTixDQUFiLENBSGdDLEVBSWhDLGdCQUFFLFVBQUYsQ0FBYSxnQkFBRSxNQUFGLENBQVMsTUFBVCxFQUFpQixTQUFqQixDQUFiLENBSmdDLEVBS2hDLGdCQUFFLGFBQUYsQ0FBZ0IsZ0JBQUUsT0FBbEIsRUFBMkIsU0FBM0IsQ0FMZ0MsQ0FBVixDQUF4Qjs7QUFRQTtBQUNBLElBQU0saUJBQWlCO0FBQ3JCLFdBQVMsQ0FEWTtBQUVyQixXQUFTO0FBRlksQ0FBdkI7O0FBS0EsSUFBTSxPQUFPLElBQWI7QUFDQSxJQUFNLGVBQWUsY0FBckI7QUFDQSxJQUFNLGVBQWUsY0FBckI7QUFDQSxJQUFNLGdCQUFnQixlQUF0QjtBQUNBLElBQU0sbUJBQW1CLGtCQUF6QjtBQUNBLElBQU0sZ0JBQWdCLGVBQXRCO0FBQ0EsSUFBTSxnQkFBZ0IsZUFBdEI7O0FBRUEsSUFBTSxzQkFBc0IsQ0FBQyxjQUFELENBQTVCO0FBQ0EsSUFBTSxnQ0FBZ0MsQ0FBQyxXQUFELEVBQWMsY0FBZCxFQUE4QixZQUE5QixDQUF0QztBQUNBLElBQU0sU0FBUyxxQkFBRyxRQUFILENBQVksR0FBWixFQUFpQixHQUFqQixDQUFmO0FBQ0EsSUFBTSxTQUFTLHFCQUFHLFFBQUgsQ0FBWSxHQUFaLEVBQWlCLEdBQWpCLENBQWY7QUFDQSxJQUFNLFNBQVMscUJBQUcsUUFBSCxDQUFZLEdBQVosRUFBaUIsR0FBakIsQ0FBZjs7QUFFQTs7O0FBR0EsSUFBTSxTQUFTLFNBQVQsTUFBUyxDQUFDLE1BQUQsRUFBWTtBQUN6QjtBQUNBLE1BQUksZ0JBQWdCLE1BQWhCLENBQUosRUFBNkIsTUFBTSxJQUFJLEtBQUosQ0FBVSw0QkFBVixDQUFOOztBQUU3QjtBQUNBLE1BQU0saUJBQWlCLGdCQUFFLEtBQUYsQ0FBUSxjQUFSLEVBQXdCLE1BQXhCLENBQXZCOztBQUVBO0FBQ0EsTUFBTSxXQUFXLGdCQUFNLE1BQU4sQ0FBYSxjQUFiLENBQWpCO0FBQ0EsTUFBTSxXQUFXLEVBQWpCO0FBQ0EsTUFBTSxhQUFhLFNBQWIsVUFBYSxDQUFDLE9BQUQsRUFBYTtBQUM5QixhQUFTLElBQVQsQ0FBYyxPQUFkO0FBQ0QsR0FGRDs7QUFJQTtBQUNBLE1BQU0sUUFBUTtBQUNaLG1CQUFlLFFBREg7QUFFWixzQkFGWTtBQUdaO0FBSFksR0FBZDs7QUFNQTtBQUNBLFFBQU0sR0FBTixHQUFZLGdCQUFFLE9BQUYsQ0FBVSxvQkFBVixFQUFnQyxDQUFDLEtBQUQsRUFBUSxLQUFSLENBQWhDLENBQVo7QUFDQSxRQUFNLE1BQU4sR0FBZSxnQkFBRSxPQUFGLENBQVUsb0JBQVYsRUFBZ0MsQ0FBQyxLQUFELEVBQVEsUUFBUixDQUFoQyxDQUFmO0FBQ0EsUUFBTSxJQUFOLEdBQWEsZ0JBQUUsT0FBRixDQUFVLG9CQUFWLEVBQWdDLENBQUMsS0FBRCxFQUFRLE1BQVIsQ0FBaEMsQ0FBYjtBQUNBLFFBQU0sSUFBTixHQUFhLGdCQUFFLE9BQUYsQ0FBVSxpQkFBVixFQUE2QixDQUFDLEtBQUQsRUFBUSxNQUFSLENBQTdCLENBQWI7QUFDQSxRQUFNLElBQU4sR0FBYSxnQkFBRSxPQUFGLENBQVUsb0JBQVYsRUFBZ0MsQ0FBQyxLQUFELEVBQVEsTUFBUixDQUFoQyxDQUFiO0FBQ0EsUUFBTSxHQUFOLEdBQVksZ0JBQUUsT0FBRixDQUFVLGlCQUFWLEVBQTZCLENBQUMsS0FBRCxFQUFRLEtBQVIsQ0FBN0IsQ0FBWjtBQUNBLFFBQU0sS0FBTixHQUFjLGdCQUFFLE9BQUYsQ0FBVSxpQkFBVixFQUE2QixDQUFDLEtBQUQsRUFBUSxPQUFSLENBQTdCLENBQWQ7O0FBRUE7QUFDQSxTQUFPLEtBQVA7QUFDRCxDQWhDRDs7QUFrQ0E7OztBQUdBLElBQU0sdUJBQXVCLFNBQXZCLG9CQUF1QixDQUFDLEdBQUQsRUFBTSxNQUFOLEVBQWMsR0FBZCxFQUFxRDtBQUFBLE1BQWxDLE1BQWtDLHlEQUF6QixFQUF5QjtBQUFBLE1BQXJCLFdBQXFCLHlEQUFQLEVBQU87O0FBQ2hGLFNBQU8sVUFBVSxHQUFWLEVBQWUsZ0JBQUUsS0FBRixDQUFRLEVBQUMsUUFBRCxFQUFNLGNBQU4sRUFBYyxjQUFkLEVBQVIsRUFBK0IsV0FBL0IsQ0FBZixDQUFQO0FBQ0QsQ0FGRDs7QUFJQTs7O0FBR0EsSUFBTSxvQkFBb0IsU0FBcEIsaUJBQW9CLENBQUMsR0FBRCxFQUFNLE1BQU4sRUFBYyxHQUFkLEVBQXFEO0FBQUEsTUFBbEMsSUFBa0MseURBQTNCLElBQTJCO0FBQUEsTUFBckIsV0FBcUIseURBQVAsRUFBTzs7QUFDN0UsU0FBTyxVQUFVLEdBQVYsRUFBZSxnQkFBRSxLQUFGLENBQVEsRUFBQyxRQUFELEVBQU0sY0FBTixFQUFjLFVBQWQsRUFBUixFQUE2QixXQUE3QixDQUFmLENBQVA7QUFDRCxDQUZEOztBQUlBOzs7QUFHQSxJQUFNLFlBQVksU0FBWixTQUFZLENBQUMsR0FBRCxFQUFNLGtCQUFOLEVBQTZCO0FBQUEsTUFDdEMsYUFEc0MsR0FDckIsR0FEcUIsQ0FDdEMsYUFEc0M7O0FBRTdDLE1BQU0sWUFBWSxxQkFBRyxRQUFILENBQVksSUFBSSxJQUFKLEVBQVosQ0FBbEI7O0FBRUE7QUFDQSxNQUFNLFFBQVEsZ0JBQUUsSUFBRixDQUNaLGdCQUFFLE9BQUYsQ0FBVSxlQUFWLEVBQTJCLENBQUMsU0FBRCxDQUEzQixDQURZLEVBRVosZ0JBQUUsT0FBRixDQUFVLFdBQVYsRUFBdUIsQ0FBQyxHQUFELENBQXZCLENBRlksQ0FBZDs7QUFLQTtBQUNBLFNBQU8sY0FDSixPQURJLENBQ0ksa0JBREosRUFFSixJQUZJLENBRUMsS0FGRCxFQUdKLEtBSEksQ0FHRSxLQUhGLENBQVA7QUFJRCxDQWZEOztBQWlCQTs7OztBQUlBLElBQU0sY0FBYyxTQUFkLFdBQWMsQ0FBQyxHQUFELEVBQU0sV0FBTixFQUFzQjtBQUN4QyxNQUFJLFFBQUosQ0FBYSxPQUFiLENBQXFCLFVBQUMsRUFBRCxFQUFRO0FBQzNCLFFBQUk7QUFDRixTQUFHLFdBQUg7QUFDRCxLQUZELENBRUUsT0FBTyxLQUFQLEVBQWM7QUFDZDtBQUNEO0FBQ0YsR0FORDtBQU9BLFNBQU8sV0FBUDtBQUNELENBVEQ7O0FBV0E7OztBQUdBLElBQU0sa0JBQWtCLFNBQWxCLGVBQWtCLENBQUMsU0FBRCxFQUFZLGFBQVosRUFBOEI7QUFDcEQsTUFBTSxNQUFNLHFCQUFHLFFBQUgsQ0FBWSxJQUFJLElBQUosRUFBWixDQUFaO0FBQ0EsTUFBTSxXQUFZLE1BQU0sU0FBeEI7QUFDQSxTQUFPO0FBQ0wsc0JBREs7QUFFTCxhQUFTLGtCQUFrQixhQUFsQixDQUZKO0FBR0wsUUFBSSxnQkFBRSxJQUFGLENBQU8sZ0JBQUUsTUFBRixDQUFTLENBQVQsRUFBWSxRQUFaLENBQVAsRUFBOEIsTUFBOUIsRUFBc0MsYUFBdEMsQ0FIQztBQUlMLFlBQVEsY0FBYyxNQUFkLElBQXdCLElBSjNCO0FBS0wsYUFBUyxjQUFjLE9BQWQsSUFBeUIsSUFMN0I7QUFNTCxZQUFRLGNBQWMsTUFBZCxJQUF3QixJQU4zQjtBQU9MLFVBQU0sY0FBYyxJQUFkLElBQXNCO0FBUHZCLEdBQVA7QUFTRCxDQVpEOztBQWNBOzs7Ozs7QUFNQSxJQUFNLG9CQUFvQixTQUFwQixpQkFBb0IsQ0FBQyxRQUFELEVBQWM7QUFDdEMsTUFBSSxvQkFBb0IsS0FBeEIsRUFBK0I7QUFDN0IsV0FBTyxnQkFBRSxJQUFGLENBQU8sQ0FDWixDQUFDLGdCQUFFLFFBQUYsQ0FBVyxnQkFBRSxFQUFiLEVBQWlCLG1CQUFqQixDQUFELEVBQXdDLGdCQUFFLE1BQUYsQ0FBUyxhQUFULENBQXhDLENBRFksRUFFWixDQUFDLGdCQUFFLFFBQUYsQ0FBVyxnQkFBRSxFQUFiLEVBQWlCLDZCQUFqQixDQUFELEVBQWtELGdCQUFFLE1BQUYsQ0FBUyxnQkFBVCxDQUFsRCxDQUZZLEVBR1osQ0FBQyxnQkFBRSxDQUFILEVBQU0sZ0JBQUUsTUFBRixDQUFTLGFBQVQsQ0FBTixDQUhZLENBQVAsRUFJSixTQUFTLElBSkwsQ0FBUDtBQUtEO0FBQ0QsTUFBSSxnQkFBRSxLQUFGLENBQVEsUUFBUixLQUFxQixDQUFDLGdCQUFFLEdBQUYsQ0FBTSxRQUFOLENBQTFCLEVBQTJDLE9BQU8sYUFBUDtBQUMzQyxTQUFPLGdCQUFFLElBQUYsQ0FBTyxDQUNaLENBQUMsTUFBRCxFQUFTLGdCQUFFLE1BQUYsQ0FBUyxJQUFULENBQVQsQ0FEWSxFQUVaLENBQUMsTUFBRCxFQUFTLGdCQUFFLE1BQUYsQ0FBUyxZQUFULENBQVQsQ0FGWSxFQUdaLENBQUMsTUFBRCxFQUFTLGdCQUFFLE1BQUYsQ0FBUyxZQUFULENBQVQsQ0FIWSxFQUlaLENBQUMsZ0JBQUUsQ0FBSCxFQUFNLGdCQUFFLE1BQUYsQ0FBUyxhQUFULENBQU4sQ0FKWSxDQUFQLEVBS0osU0FBUyxNQUFULElBQW1CLENBTGYsQ0FBUDtBQU1ELENBZkQ7O0FBaUJBLE9BQU8sT0FBUCxHQUFpQjtBQUNmLHNDQURlO0FBRWYsZ0JBRmU7QUFHZixZQUhlO0FBSWYsNEJBSmU7QUFLZiw0QkFMZTtBQU1mLDhCQU5lO0FBT2Ysb0NBUGU7QUFRZiw4QkFSZTtBQVNmO0FBVGUsQ0FBakI7O1FBWVMsSSxHQUFBLEk7UUFBTSxZLEdBQUEsWTtRQUFjLFksR0FBQSxZO1FBQWMsYSxHQUFBLGE7UUFBZSxnQixHQUFBLGdCO1FBQWtCLGEsR0FBQSxhO1FBQWUsYSxHQUFBLGE7UUFBZSxNLEdBQUEsTTtRQUFRLGlCLEdBQUEsaUIiLCJmaWxlIjoiYXBpc2F1Y2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnO1xuaW1wb3J0IFIgZnJvbSAncmFtZGEnO1xuaW1wb3J0IFJTIGZyb20gJ3JhbWRhc2F1Y2UnO1xuXG4vLyBjaGVjayBmb3IgYW4gaW52YWxpZCBjb25maWdcclxuY29uc3QgaXNJbnZhbGlkQ29uZmlnID0gUi5hbnlQYXNzKFtcclxuICBSLmlzTmlsLFxyXG4gIFIuaXNFbXB0eSxcclxuICBSLmNvbXBsZW1lbnQoUi5oYXMoJ2Jhc2VVUkwnKSksXHJcbiAgUi5jb21wbGVtZW50KFIucHJvcElzKFN0cmluZywgJ2Jhc2VVUkwnKSksXHJcbiAgUi5wcm9wU2F0aXNmaWVzKFIuaXNFbXB0eSwgJ2Jhc2VVUkwnKVxyXG5dKVxyXG5cclxuLy8gdGhlIGRlZmF1bHQgY29uZmlndXJhdGlvbiBmb3IgYXhpb3NcclxuY29uc3QgREVGQVVMVF9DT05GSUcgPSB7XHJcbiAgdGltZW91dDogMCxcclxuICBoZWFkZXJzOiB7fVxyXG59XHJcblxyXG5jb25zdCBOT05FID0gbnVsbFxyXG5jb25zdCBDTElFTlRfRVJST1IgPSAnQ0xJRU5UX0VSUk9SJ1xyXG5jb25zdCBTRVJWRVJfRVJST1IgPSAnU0VSVkVSX0VSUk9SJ1xyXG5jb25zdCBUSU1FT1VUX0VSUk9SID0gJ1RJTUVPVVRfRVJST1InXHJcbmNvbnN0IENPTk5FQ1RJT05fRVJST1IgPSAnQ09OTkVDVElPTl9FUlJPUidcclxuY29uc3QgTkVUV09SS19FUlJPUiA9ICdORVRXT1JLX0VSUk9SJ1xyXG5jb25zdCBVTktOT1dOX0VSUk9SID0gJ1VOS05PV05fRVJST1InXHJcblxyXG5jb25zdCBUSU1FT1VUX0VSUk9SX0NPREVTID0gWydFQ09OTkFCT1JURUQnXVxyXG5jb25zdCBOT0RFSlNfQ09OTkVDVElPTl9FUlJPUl9DT0RFUyA9IFsnRU5PVEZPVU5EJywgJ0VDT05OUkVGVVNFRCcsICdFQ09OTlJFU0VUJ11cclxuY29uc3QgaW4yMDBzID0gUlMuaXNXaXRoaW4oMjAwLCAyOTkpXHJcbmNvbnN0IGluNDAwcyA9IFJTLmlzV2l0aGluKDQwMCwgNDk5KVxyXG5jb25zdCBpbjUwMHMgPSBSUy5pc1dpdGhpbig1MDAsIDU5OSlcclxuXHJcbi8qKlxyXG4gIENyZWF0ZXMgYSBpbnN0YW5jZSBvZiBvdXIgQVBJIHVzaW5nIHRoZSBjb25maWd1cmF0aW9uLlxyXG4gKi9cclxuY29uc3QgY3JlYXRlID0gKGNvbmZpZykgPT4ge1xyXG4gIC8vIHF1aWNrIHNhbml0eSBjaGVja1xyXG4gIGlmIChpc0ludmFsaWRDb25maWcoY29uZmlnKSkgdGhyb3cgbmV3IEVycm9yKCdjb25maWcgbXVzdCBoYXZlIGEgYmFzZVVSTCcpXHJcblxyXG4gIC8vIGNvbWJpbmUgdGhlIHVzZXIncyBkZWZhdWx0cyB3aXRoIG91cnNcclxuICBjb25zdCBjb21iaW5lZENvbmZpZyA9IFIubWVyZ2UoREVGQVVMVF9DT05GSUcsIGNvbmZpZylcclxuXHJcbiAgLy8gY3JlYXRlIHRoZSBheGlvcyBpbnN0YW5jZVxyXG4gIGNvbnN0IGluc3RhbmNlID0gYXhpb3MuY3JlYXRlKGNvbWJpbmVkQ29uZmlnKVxyXG4gIGNvbnN0IG1vbml0b3JzID0gW11cclxuICBjb25zdCBhZGRNb25pdG9yID0gKG1vbml0b3IpID0+IHtcclxuICAgIG1vbml0b3JzLnB1c2gobW9uaXRvcilcclxuICB9XHJcblxyXG4gIC8vIGNyZWF0ZSB0aGUgYmFzZSBvYmplY3RcclxuICBjb25zdCBzYXVjZSA9IHtcclxuICAgIGF4aW9zSW5zdGFuY2U6IGluc3RhbmNlLFxyXG4gICAgbW9uaXRvcnMsXHJcbiAgICBhZGRNb25pdG9yXHJcbiAgfVxyXG5cclxuICAvLyBhdHRhY2ggZnVuY3Rpb25zIGZvciBlYWNoIG91ciBIVFRQIHZlcmJzXHJcbiAgc2F1Y2UuZ2V0ID0gUi5wYXJ0aWFsKGRvUmVxdWVzdFdpdGhvdXRCb2R5LCBbc2F1Y2UsICdnZXQnXSlcclxuICBzYXVjZS5kZWxldGUgPSBSLnBhcnRpYWwoZG9SZXF1ZXN0V2l0aG91dEJvZHksIFtzYXVjZSwgJ2RlbGV0ZSddKVxyXG4gIHNhdWNlLmhlYWQgPSBSLnBhcnRpYWwoZG9SZXF1ZXN0V2l0aG91dEJvZHksIFtzYXVjZSwgJ2hlYWQnXSlcclxuICBzYXVjZS5wb3N0ID0gUi5wYXJ0aWFsKGRvUmVxdWVzdFdpdGhCb2R5LCBbc2F1Y2UsICdwb3N0J10pXHJcbiAgc2F1Y2UuY2FsbCA9IFIucGFydGlhbChkb1JlcXVlc3RXaXRob3V0Qm9keSwgW3NhdWNlLCAncG9zdCddKVxyXG4gIHNhdWNlLnB1dCA9IFIucGFydGlhbChkb1JlcXVlc3RXaXRoQm9keSwgW3NhdWNlLCAncHV0J10pXHJcbiAgc2F1Y2UucGF0Y2ggPSBSLnBhcnRpYWwoZG9SZXF1ZXN0V2l0aEJvZHksIFtzYXVjZSwgJ3BhdGNoJ10pXHJcblxyXG4gIC8vIHNlbmQgaXQgYmFja1xyXG4gIHJldHVybiBzYXVjZVxyXG59XHJcblxyXG4vKipcclxuICBNYWtlIHRoZSByZXF1ZXN0IGZvciBHRVQsIEhFQUQsIERFTEVURVxyXG4gKi9cclxuY29uc3QgZG9SZXF1ZXN0V2l0aG91dEJvZHkgPSAoYXBpLCBtZXRob2QsIHVybCwgcGFyYW1zID0ge30sIGF4aW9zQ29uZmlnID0ge30pID0+IHtcclxuICByZXR1cm4gZG9SZXF1ZXN0KGFwaSwgUi5tZXJnZSh7dXJsLCBwYXJhbXMsIG1ldGhvZH0sIGF4aW9zQ29uZmlnKSlcclxufVxyXG5cclxuLyoqXHJcbiAgTWFrZSB0aGUgcmVxdWVzdCBmb3IgUE9TVCwgUFVULCBQQVRDSFxyXG4gKi9cclxuY29uc3QgZG9SZXF1ZXN0V2l0aEJvZHkgPSAoYXBpLCBtZXRob2QsIHVybCwgZGF0YSA9IG51bGwsIGF4aW9zQ29uZmlnID0ge30pID0+IHtcclxuICByZXR1cm4gZG9SZXF1ZXN0KGFwaSwgUi5tZXJnZSh7dXJsLCBtZXRob2QsIGRhdGF9LCBheGlvc0NvbmZpZykpXHJcbn1cclxuXHJcbi8qKlxyXG4gIE1ha2UgdGhlIHJlcXVlc3Qgd2l0aCB0aGlzIGNvbmZpZyFcclxuICovXHJcbmNvbnN0IGRvUmVxdWVzdCA9IChhcGksIGF4aW9zUmVxdWVzdENvbmZpZykgPT4ge1xyXG4gIGNvbnN0IHtheGlvc0luc3RhbmNlfSA9IGFwaVxyXG4gIGNvbnN0IHN0YXJ0ZWRBdCA9IFJTLnRvTnVtYmVyKG5ldyBEYXRlKCkpXHJcblxyXG4gIC8vIGZpcnN0IGNvbnZlcnQgdGhlIGF4aW9zIHJlc3BvbnNlLCB0aGVuIGV4ZWN1dGUgb3VyIGNhbGxiYWNrXHJcbiAgY29uc3QgY2hhaW4gPSBSLnBpcGUoXHJcbiAgICBSLnBhcnRpYWwoY29udmVydFJlc3BvbnNlLCBbc3RhcnRlZEF0XSksXHJcbiAgICBSLnBhcnRpYWwocnVuTW9uaXRvcnMsIFthcGldKVxyXG4gIClcclxuXHJcbiAgLy8gTWFrZSB0aGUgcmVxdWVzdCBhbmQgZXhlY3V0ZSB0aGUgaWRlbnRpY2FsIHBpcGVsaW5lIGZvciBib3RoIHByb21pc2UgcGF0aHMuXHJcbiAgcmV0dXJuIGF4aW9zSW5zdGFuY2VcclxuICAgIC5yZXF1ZXN0KGF4aW9zUmVxdWVzdENvbmZpZylcclxuICAgIC50aGVuKGNoYWluKVxyXG4gICAgLmNhdGNoKGNoYWluKVxyXG59XHJcblxyXG4vKipcclxuICBGaXJlcyBhZnRlciB3ZSBjb252ZXJ0IGZyb20gYXhpb3MnIHJlc3BvbnNlIGludG8gb3VyIHJlc3BvbnNlLiAgRXhjZXB0aW9uc1xyXG4gIHJhaXNlZCBmb3IgZWFjaCBtb25pdG9yIHdpbGwgYmUgaWdub3JlZC5cclxuICovXHJcbmNvbnN0IHJ1bk1vbml0b3JzID0gKGFwaSwgb3VyUmVzcG9uc2UpID0+IHtcclxuICBhcGkubW9uaXRvcnMuZm9yRWFjaCgoZm4pID0+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGZuKG91clJlc3BvbnNlKVxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgLy8gYWxsIG1vbml0b3IgY29tcGxhaW50cyB3aWxsIGJlIGlnbm9yZWRcclxuICAgIH1cclxuICB9KVxyXG4gIHJldHVybiBvdXJSZXNwb25zZVxyXG59XHJcblxyXG4vKipcclxuICBDb252ZXJ0cyBhbiBheGlvcyByZXNwb25zZS9lcnJvciBpbnRvIG91ciByZXNwb25zZS5cclxuICovXHJcbmNvbnN0IGNvbnZlcnRSZXNwb25zZSA9IChzdGFydGVkQXQsIGF4aW9zUmVzcG9uc2UpID0+IHtcclxuICBjb25zdCBlbmQgPSBSUy50b051bWJlcihuZXcgRGF0ZSgpKVxyXG4gIGNvbnN0IGR1cmF0aW9uID0gKGVuZCAtIHN0YXJ0ZWRBdClcclxuICByZXR1cm4ge1xyXG4gICAgZHVyYXRpb24sXHJcbiAgICBwcm9ibGVtOiByZXNwb25zZVRvUHJvYmxlbShheGlvc1Jlc3BvbnNlKSxcclxuICAgIG9rOiBSLnBpcGUoUi5wcm9wT3IoMCwgJ3N0YXR1cycpLCBpbjIwMHMpKGF4aW9zUmVzcG9uc2UpLFxyXG4gICAgc3RhdHVzOiBheGlvc1Jlc3BvbnNlLnN0YXR1cyB8fCBudWxsLFxyXG4gICAgaGVhZGVyczogYXhpb3NSZXNwb25zZS5oZWFkZXJzIHx8IG51bGwsXHJcbiAgICBjb25maWc6IGF4aW9zUmVzcG9uc2UuY29uZmlnIHx8IG51bGwsXHJcbiAgICBkYXRhOiBheGlvc1Jlc3BvbnNlLmRhdGEgfHwgbnVsbFxyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAgV2hhdCdzIHRoZSBwcm9ibGVtIGZvciB0aGlzIHJlc3BvbnNlP1xyXG5cclxuICBUT0RPOiBXZSdyZSBsb3Npbmcgc29tZSBlcnJvciBncmFudWxhcml0eSwgYnV0IGknbSBjb29sIHdpdGggdGhhdFxyXG4gIHVudGlsIHNvbWVvbmUgY2FyZXMuXHJcbiAqL1xyXG5jb25zdCByZXNwb25zZVRvUHJvYmxlbSA9IChyZXNwb25zZSkgPT4ge1xyXG4gIGlmIChyZXNwb25zZSBpbnN0YW5jZW9mIEVycm9yKSB7XHJcbiAgICByZXR1cm4gUi5jb25kKFtcclxuICAgICAgW1IuY29udGFpbnMoUi5fXywgVElNRU9VVF9FUlJPUl9DT0RFUyksIFIuYWx3YXlzKFRJTUVPVVRfRVJST1IpXSxcclxuICAgICAgW1IuY29udGFpbnMoUi5fXywgTk9ERUpTX0NPTk5FQ1RJT05fRVJST1JfQ09ERVMpLCBSLmFsd2F5cyhDT05ORUNUSU9OX0VSUk9SKV0sXHJcbiAgICAgIFtSLlQsIFIuYWx3YXlzKFVOS05PV05fRVJST1IpXVxyXG4gICAgXSkocmVzcG9uc2UuY29kZSlcclxuICB9XHJcbiAgaWYgKFIuaXNOaWwocmVzcG9uc2UpIHx8ICFSLmhhcygnc3RhdHVzJykpIHJldHVybiBVTktOT1dOX0VSUk9SXHJcbiAgcmV0dXJuIFIuY29uZChbXHJcbiAgICBbaW4yMDBzLCBSLmFsd2F5cyhOT05FKV0sXHJcbiAgICBbaW40MDBzLCBSLmFsd2F5cyhDTElFTlRfRVJST1IpXSxcclxuICAgIFtpbjUwMHMsIFIuYWx3YXlzKFNFUlZFUl9FUlJPUildLFxyXG4gICAgW1IuVCwgUi5hbHdheXMoVU5LTk9XTl9FUlJPUildXHJcbiAgXSkocmVzcG9uc2Uuc3RhdHVzIHx8IDApXHJcbn1cclxuXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIHJlc3BvbnNlVG9Qcm9ibGVtLFxyXG4gIGNyZWF0ZSxcclxuICBOT05FLFxyXG4gIENMSUVOVF9FUlJPUixcclxuICBTRVJWRVJfRVJST1IsXHJcbiAgVElNRU9VVF9FUlJPUixcclxuICBDT05ORUNUSU9OX0VSUk9SLFxyXG4gIE5FVFdPUktfRVJST1IsXHJcbiAgVU5LTk9XTl9FUlJPUlxyXG59XG5cbmV4cG9ydCB7IE5PTkUsIENMSUVOVF9FUlJPUiwgU0VSVkVSX0VSUk9SLCBUSU1FT1VUX0VSUk9SLCBDT05ORUNUSU9OX0VSUk9SLCBORVRXT1JLX0VSUk9SLCBVTktOT1dOX0VSUk9SLCBjcmVhdGUsIHJlc3BvbnNlVG9Qcm9ibGVtIH07Il19