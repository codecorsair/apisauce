'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.responseToProblem = exports.create = exports.UNKNOWN_ERROR = exports.NETWORK_ERROR = exports.CONNECTION_ERROR = exports.TIMEOUT_ERROR = exports.SERVER_ERROR = exports.CLIENT_ERROR = exports.NONE = undefined;

var _axios = require('axios');

var _axios2 = _interopRequireDefault(_axios);

var _ramda = require('ramda');

var _ramda2 = _interopRequireDefault(_ramda);

var _ramdasauce = require('ramdasauce');

var _ramdasauce2 = _interopRequireDefault(_ramdasauce);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// check for an invalid config
var isInvalidConfig = _ramda2.default.anyPass([_ramda2.default.isNil, _ramda2.default.isEmpty, _ramda2.default.complement(_ramda2.default.has('baseURL')), _ramda2.default.complement(_ramda2.default.propIs(String, 'baseURL')), _ramda2.default.propSatisfies(_ramda2.default.isEmpty, 'baseURL')]);

// the default configuration for axios
var DEFAULT_CONFIG = {
  timeout: 0,
  headers: {}
};

var NONE = null;
var CLIENT_ERROR = 'CLIENT_ERROR';
var SERVER_ERROR = 'SERVER_ERROR';
var TIMEOUT_ERROR = 'TIMEOUT_ERROR';
var CONNECTION_ERROR = 'CONNECTION_ERROR';
var NETWORK_ERROR = 'NETWORK_ERROR';
var UNKNOWN_ERROR = 'UNKNOWN_ERROR';

var TIMEOUT_ERROR_CODES = ['ECONNABORTED'];
var NODEJS_CONNECTION_ERROR_CODES = ['ENOTFOUND', 'ECONNREFUSED', 'ECONNRESET'];
var in200s = _ramdasauce2.default.isWithin(200, 299);
var in400s = _ramdasauce2.default.isWithin(400, 499);
var in500s = _ramdasauce2.default.isWithin(500, 599);

/**
  Creates a instance of our API using the configuration.
 */
var create = function create(config) {
  // quick sanity check
  if (isInvalidConfig(config)) throw new Error('config must have a baseURL');

  // combine the user's defaults with ours
  var combinedConfig = _ramda2.default.merge(DEFAULT_CONFIG, config);

  // create the axios instance
  var instance = _axios2.default.create(combinedConfig);
  var monitors = [];
  var addMonitor = function addMonitor(monitor) {
    monitors.push(monitor);
  };

  // create the base object
  var sauce = {
    axiosInstance: instance,
    monitors: monitors,
    addMonitor: addMonitor
  };

  // attach functions for each our HTTP verbs
  sauce.get = _ramda2.default.partial(doRequestWithoutBody, [sauce, 'get']);
  sauce.delete = _ramda2.default.partial(doRequestWithoutBody, [sauce, 'delete']);
  sauce.head = _ramda2.default.partial(doRequestWithoutBody, [sauce, 'head']);
  sauce.post = _ramda2.default.partial(doRequestWithBody, [sauce, 'post']);
  sauce.call = _ramda2.default.partial(doRequestWithoutBody, [sauce, 'post']);
  sauce.put = _ramda2.default.partial(doRequestWithBody, [sauce, 'put']);
  sauce.patch = _ramda2.default.partial(doRequestWithBody, [sauce, 'patch']);

  // send it back
  return sauce;
};

/**
  Make the request for GET, HEAD, DELETE
 */
var doRequestWithoutBody = function doRequestWithoutBody(api, method, url) {
  var params = arguments.length <= 3 || arguments[3] === undefined ? {} : arguments[3];
  var axiosConfig = arguments.length <= 4 || arguments[4] === undefined ? {} : arguments[4];

  return doRequest(api, _ramda2.default.merge({ url: url, params: params, method: method }, axiosConfig));
};

/**
  Make the request for POST, PUT, PATCH
 */
var doRequestWithBody = function doRequestWithBody(api, method, url) {
  var data = arguments.length <= 3 || arguments[3] === undefined ? null : arguments[3];
  var axiosConfig = arguments.length <= 4 || arguments[4] === undefined ? {} : arguments[4];

  return doRequest(api, _ramda2.default.merge({ url: url, method: method, data: data }, axiosConfig));
};

/**
  Make the request with this config!
 */
var doRequest = function doRequest(api, axiosRequestConfig) {
  var axiosInstance = api.axiosInstance;

  var startedAt = _ramdasauce2.default.toNumber(new Date());

  // first convert the axios response, then execute our callback
  var chain = _ramda2.default.pipe(_ramda2.default.partial(convertResponse, [startedAt]), _ramda2.default.partial(runMonitors, [api]));

  // Make the request and execute the identical pipeline for both promise paths.
  return axiosInstance.request(axiosRequestConfig).then(chain).catch(chain);
};

/**
  Fires after we convert from axios' response into our response.  Exceptions
  raised for each monitor will be ignored.
 */
var runMonitors = function runMonitors(api, ourResponse) {
  api.monitors.forEach(function (fn) {
    try {
      fn(ourResponse);
    } catch (error) {
      // all monitor complaints will be ignored
    }
  });
  return ourResponse;
};

/**
  Converts an axios response/error into our response.
 */
var convertResponse = function convertResponse(startedAt, axiosResponse) {
  var end = _ramdasauce2.default.toNumber(new Date());
  var duration = end - startedAt;
  return {
    duration: duration,
    problem: responseToProblem(axiosResponse),
    ok: _ramda2.default.pipe(_ramda2.default.propOr(0, 'status'), in200s)(axiosResponse),
    status: axiosResponse.status || null,
    headers: axiosResponse.headers || null,
    config: axiosResponse.config || null,
    data: axiosResponse.data || null
  };
};

/**
  What's the problem for this response?

  TODO: We're losing some error granularity, but i'm cool with that
  until someone cares.
 */
var responseToProblem = function responseToProblem(response) {
  if (response instanceof Error) {
    return _ramda2.default.cond([[_ramda2.default.contains(_ramda2.default.__, TIMEOUT_ERROR_CODES), _ramda2.default.always(TIMEOUT_ERROR)], [_ramda2.default.contains(_ramda2.default.__, NODEJS_CONNECTION_ERROR_CODES), _ramda2.default.always(CONNECTION_ERROR)], [_ramda2.default.T, _ramda2.default.always(UNKNOWN_ERROR)]])(response.code);
  }
  if (_ramda2.default.isNil(response) || !_ramda2.default.has('status')) return UNKNOWN_ERROR;
  return _ramda2.default.cond([[in200s, _ramda2.default.always(NONE)], [in400s, _ramda2.default.always(CLIENT_ERROR)], [in500s, _ramda2.default.always(SERVER_ERROR)], [_ramda2.default.T, _ramda2.default.always(UNKNOWN_ERROR)]])(response.status || 0);
};

module.exports = {
  responseToProblem: responseToProblem,
  create: create,
  NONE: NONE,
  CLIENT_ERROR: CLIENT_ERROR,
  SERVER_ERROR: SERVER_ERROR,
  TIMEOUT_ERROR: TIMEOUT_ERROR,
  CONNECTION_ERROR: CONNECTION_ERROR,
  NETWORK_ERROR: NETWORK_ERROR,
  UNKNOWN_ERROR: UNKNOWN_ERROR
};

exports.NONE = NONE;
exports.CLIENT_ERROR = CLIENT_ERROR;
exports.SERVER_ERROR = SERVER_ERROR;
exports.TIMEOUT_ERROR = TIMEOUT_ERROR;
exports.CONNECTION_ERROR = CONNECTION_ERROR;
exports.NETWORK_ERROR = NETWORK_ERROR;
exports.UNKNOWN_ERROR = UNKNOWN_ERROR;
exports.create = create;
exports.responseToProblem = responseToProblem;
//# sourceMappingURL=data:application/json;base64,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SUosU0FBUyxJQUpMLENBQVA7QUFLRDtBQUNELE1BQUksZ0JBQUUsS0FBRixDQUFRLFFBQVIsS0FBcUIsQ0FBQyxnQkFBRSxHQUFGLENBQU0sUUFBTixDQUExQixFQUEyQyxPQUFPLGFBQVA7QUFDM0MsU0FBTyxnQkFBRSxJQUFGLENBQU8sQ0FDWixDQUFDLE1BQUQsRUFBUyxnQkFBRSxNQUFGLENBQVMsSUFBVCxDQUFULENBRFksRUFFWixDQUFDLE1BQUQsRUFBUyxnQkFBRSxNQUFGLENBQVMsWUFBVCxDQUFULENBRlksRUFHWixDQUFDLE1BQUQsRUFBUyxnQkFBRSxNQUFGLENBQVMsWUFBVCxDQUFULENBSFksRUFJWixDQUFDLGdCQUFFLENBQUgsRUFBTSxnQkFBRSxNQUFGLENBQVMsYUFBVCxDQUFOLENBSlksQ0FBUCxFQUtKLFNBQVMsTUFBVCxJQUFtQixDQUxmLENBQVA7QUFNRCxDQWZEOztBQWlCQSxPQUFPLE9BQVAsR0FBaUI7QUFDZixzQ0FEZTtBQUVmLGdCQUZlO0FBR2YsWUFIZTtBQUlmLDRCQUplO0FBS2YsNEJBTGU7QUFNZiw4QkFOZTtBQU9mLG9DQVBlO0FBUWYsOEJBUmU7QUFTZjtBQVRlLENBQWpCOztRQVlTLEksR0FBQSxJO1FBQU0sWSxHQUFBLFk7UUFBYyxZLEdBQUEsWTtRQUFjLGEsR0FBQSxhO1FBQWUsZ0IsR0FBQSxnQjtRQUFrQixhLEdBQUEsYTtRQUFlLGEsR0FBQSxhO1FBQWUsTSxHQUFBLE07UUFBUSxpQixHQUFBLGlCIiwiZmlsZSI6ImFwaXNhdWNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGF4aW9zIGZyb20gJ2F4aW9zJztcbmltcG9ydCBSIGZyb20gJ3JhbWRhJztcbmltcG9ydCBSUyBmcm9tICdyYW1kYXNhdWNlJztcblxuLy8gY2hlY2sgZm9yIGFuIGludmFsaWQgY29uZmlnXHJcbmNvbnN0IGlzSW52YWxpZENvbmZpZyA9IFIuYW55UGFzcyhbXHJcbiAgUi5pc05pbCxcclxuICBSLmlzRW1wdHksXHJcbiAgUi5jb21wbGVtZW50KFIuaGFzKCdiYXNlVVJMJykpLFxyXG4gIFIuY29tcGxlbWVudChSLnByb3BJcyhTdHJpbmcsICdiYXNlVVJMJykpLFxyXG4gIFIucHJvcFNhdGlzZmllcyhSLmlzRW1wdHksICdiYXNlVVJMJylcclxuXSlcclxuXHJcbi8vIHRoZSBkZWZhdWx0IGNvbmZpZ3VyYXRpb24gZm9yIGF4aW9zXHJcbmNvbnN0IERFRkFVTFRfQ09ORklHID0ge1xyXG4gIHRpbWVvdXQ6IDAsXHJcbiAgaGVhZGVyczoge31cclxufVxyXG5cclxuY29uc3QgTk9ORSA9IG51bGxcclxuY29uc3QgQ0xJRU5UX0VSUk9SID0gJ0NMSUVOVF9FUlJPUidcclxuY29uc3QgU0VSVkVSX0VSUk9SID0gJ1NFUlZFUl9FUlJPUidcclxuY29uc3QgVElNRU9VVF9FUlJPUiA9ICdUSU1FT1VUX0VSUk9SJ1xyXG5jb25zdCBDT05ORUNUSU9OX0VSUk9SID0gJ0NPTk5FQ1RJT05fRVJST1InXHJcbmNvbnN0IE5FVFdPUktfRVJST1IgPSAnTkVUV09SS19FUlJPUidcclxuY29uc3QgVU5LTk9XTl9FUlJPUiA9ICdVTktOT1dOX0VSUk9SJ1xyXG5cclxuY29uc3QgVElNRU9VVF9FUlJPUl9DT0RFUyA9IFsnRUNPTk5BQk9SVEVEJ11cclxuY29uc3QgTk9ERUpTX0NPTk5FQ1RJT05fRVJST1JfQ09ERVMgPSBbJ0VOT1RGT1VORCcsICdFQ09OTlJFRlVTRUQnLCAnRUNPTk5SRVNFVCddXHJcbmNvbnN0IGluMjAwcyA9IFJTLmlzV2l0aGluKDIwMCwgMjk5KVxyXG5jb25zdCBpbjQwMHMgPSBSUy5pc1dpdGhpbig0MDAsIDQ5OSlcclxuY29uc3QgaW41MDBzID0gUlMuaXNXaXRoaW4oNTAwLCA1OTkpXHJcblxyXG4vKipcclxuICBDcmVhdGVzIGEgaW5zdGFuY2Ugb2Ygb3VyIEFQSSB1c2luZyB0aGUgY29uZmlndXJhdGlvbi5cclxuICovXHJcbmNvbnN0IGNyZWF0ZSA9IChjb25maWcpID0+IHtcclxuICAvLyBxdWljayBzYW5pdHkgY2hlY2tcclxuICBpZiAoaXNJbnZhbGlkQ29uZmlnKGNvbmZpZykpIHRocm93IG5ldyBFcnJvcignY29uZmlnIG11c3QgaGF2ZSBhIGJhc2VVUkwnKVxyXG5cclxuICAvLyBjb21iaW5lIHRoZSB1c2VyJ3MgZGVmYXVsdHMgd2l0aCBvdXJzXHJcbiAgY29uc3QgY29tYmluZWRDb25maWcgPSBSLm1lcmdlKERFRkFVTFRfQ09ORklHLCBjb25maWcpXHJcblxyXG4gIC8vIGNyZWF0ZSB0aGUgYXhpb3MgaW5zdGFuY2VcclxuICBjb25zdCBpbnN0YW5jZSA9IGF4aW9zLmNyZWF0ZShjb21iaW5lZENvbmZpZylcclxuICBjb25zdCBtb25pdG9ycyA9IFtdXHJcbiAgY29uc3QgYWRkTW9uaXRvciA9IChtb25pdG9yKSA9PiB7XHJcbiAgICBtb25pdG9ycy5wdXNoKG1vbml0b3IpXHJcbiAgfVxyXG5cclxuICAvLyBjcmVhdGUgdGhlIGJhc2Ugb2JqZWN0XHJcbiAgY29uc3Qgc2F1Y2UgPSB7XHJcbiAgICBheGlvc0luc3RhbmNlOiBpbnN0YW5jZSxcclxuICAgIG1vbml0b3JzLFxyXG4gICAgYWRkTW9uaXRvclxyXG4gIH1cclxuXHJcbiAgLy8gYXR0YWNoIGZ1bmN0aW9ucyBmb3IgZWFjaCBvdXIgSFRUUCB2ZXJic1xyXG4gIHNhdWNlLmdldCA9IFIucGFydGlhbChkb1JlcXVlc3RXaXRob3V0Qm9keSwgW3NhdWNlLCAnZ2V0J10pXHJcbiAgc2F1Y2UuZGVsZXRlID0gUi5wYXJ0aWFsKGRvUmVxdWVzdFdpdGhvdXRCb2R5LCBbc2F1Y2UsICdkZWxldGUnXSlcclxuICBzYXVjZS5oZWFkID0gUi5wYXJ0aWFsKGRvUmVxdWVzdFdpdGhvdXRCb2R5LCBbc2F1Y2UsICdoZWFkJ10pXHJcbiAgc2F1Y2UucG9zdCA9IFIucGFydGlhbChkb1JlcXVlc3RXaXRoQm9keSwgW3NhdWNlLCAncG9zdCddKVxyXG4gIHNhdWNlLmNhbGwgPSBSLnBhcnRpYWwoZG9SZXF1ZXN0V2l0aG91dEJvZHksIFtzYXVjZSwgJ3Bvc3QnXSlcclxuICBzYXVjZS5wdXQgPSBSLnBhcnRpYWwoZG9SZXF1ZXN0V2l0aEJvZHksIFtzYXVjZSwgJ3B1dCddKVxyXG4gIHNhdWNlLnBhdGNoID0gUi5wYXJ0aWFsKGRvUmVxdWVzdFdpdGhCb2R5LCBbc2F1Y2UsICdwYXRjaCddKVxyXG5cclxuICAvLyBzZW5kIGl0IGJhY2tcclxuICByZXR1cm4gc2F1Y2VcclxufVxyXG5cclxuLyoqXHJcbiAgTWFrZSB0aGUgcmVxdWVzdCBmb3IgR0VULCBIRUFELCBERUxFVEVcclxuICovXHJcbmNvbnN0IGRvUmVxdWVzdFdpdGhvdXRCb2R5ID0gKGFwaSwgbWV0aG9kLCB1cmwsIHBhcmFtcyA9IHt9LCBheGlvc0NvbmZpZyA9IHt9KSA9PiB7XHJcbiAgcmV0dXJuIGRvUmVxdWVzdChhcGksIFIubWVyZ2Uoe3VybCwgcGFyYW1zLCBtZXRob2R9LCBheGlvc0NvbmZpZykpXHJcbn1cclxuXHJcbi8qKlxyXG4gIE1ha2UgdGhlIHJlcXVlc3QgZm9yIFBPU1QsIFBVVCwgUEFUQ0hcclxuICovXHJcbmNvbnN0IGRvUmVxdWVzdFdpdGhCb2R5ID0gKGFwaSwgbWV0aG9kLCB1cmwsIGRhdGEgPSBudWxsLCBheGlvc0NvbmZpZyA9IHt9KSA9PiB7XHJcbiAgcmV0dXJuIGRvUmVxdWVzdChhcGksIFIubWVyZ2Uoe3VybCwgbWV0aG9kLCBkYXRhfSwgYXhpb3NDb25maWcpKVxyXG59XHJcblxyXG4vKipcclxuICBNYWtlIHRoZSByZXF1ZXN0IHdpdGggdGhpcyBjb25maWchXHJcbiAqL1xyXG5jb25zdCBkb1JlcXVlc3QgPSAoYXBpLCBheGlvc1JlcXVlc3RDb25maWcpID0+IHtcclxuICBjb25zdCB7YXhpb3NJbnN0YW5jZX0gPSBhcGlcclxuICBjb25zdCBzdGFydGVkQXQgPSBSUy50b051bWJlcihuZXcgRGF0ZSgpKVxyXG5cclxuICAvLyBmaXJzdCBjb252ZXJ0IHRoZSBheGlvcyByZXNwb25zZSwgdGhlbiBleGVjdXRlIG91ciBjYWxsYmFja1xyXG4gIGNvbnN0IGNoYWluID0gUi5waXBlKFxyXG4gICAgUi5wYXJ0aWFsKGNvbnZlcnRSZXNwb25zZSwgW3N0YXJ0ZWRBdF0pLFxyXG4gICAgUi5wYXJ0aWFsKHJ1bk1vbml0b3JzLCBbYXBpXSlcclxuICApXHJcblxyXG4gIC8vIE1ha2UgdGhlIHJlcXVlc3QgYW5kIGV4ZWN1dGUgdGhlIGlkZW50aWNhbCBwaXBlbGluZSBmb3IgYm90aCBwcm9taXNlIHBhdGhzLlxyXG4gIHJldHVybiBheGlvc0luc3RhbmNlXHJcbiAgICAucmVxdWVzdChheGlvc1JlcXVlc3RDb25maWcpXHJcbiAgICAudGhlbihjaGFpbilcclxuICAgIC5jYXRjaChjaGFpbilcclxufVxyXG5cclxuLyoqXHJcbiAgRmlyZXMgYWZ0ZXIgd2UgY29udmVydCBmcm9tIGF4aW9zJyByZXNwb25zZSBpbnRvIG91ciByZXNwb25zZS4gIEV4Y2VwdGlvbnNcclxuICByYWlzZWQgZm9yIGVhY2ggbW9uaXRvciB3aWxsIGJlIGlnbm9yZWQuXHJcbiAqL1xyXG5jb25zdCBydW5Nb25pdG9ycyA9IChhcGksIG91clJlc3BvbnNlKSA9PiB7XHJcbiAgYXBpLm1vbml0b3JzLmZvckVhY2goKGZuKSA9PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBmbihvdXJSZXNwb25zZSlcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIC8vIGFsbCBtb25pdG9yIGNvbXBsYWludHMgd2lsbCBiZSBpZ25vcmVkXHJcbiAgICB9XHJcbiAgfSlcclxuICByZXR1cm4gb3VyUmVzcG9uc2VcclxufVxyXG5cclxuLyoqXHJcbiAgQ29udmVydHMgYW4gYXhpb3MgcmVzcG9uc2UvZXJyb3IgaW50byBvdXIgcmVzcG9uc2UuXHJcbiAqL1xyXG5jb25zdCBjb252ZXJ0UmVzcG9uc2UgPSAoc3RhcnRlZEF0LCBheGlvc1Jlc3BvbnNlKSA9PiB7XHJcbiAgY29uc3QgZW5kID0gUlMudG9OdW1iZXIobmV3IERhdGUoKSlcclxuICBjb25zdCBkdXJhdGlvbiA9IChlbmQgLSBzdGFydGVkQXQpXHJcbiAgcmV0dXJuIHtcclxuICAgIGR1cmF0aW9uLFxyXG4gICAgcHJvYmxlbTogcmVzcG9uc2VUb1Byb2JsZW0oYXhpb3NSZXNwb25zZSksXHJcbiAgICBvazogUi5waXBlKFIucHJvcE9yKDAsICdzdGF0dXMnKSwgaW4yMDBzKShheGlvc1Jlc3BvbnNlKSxcclxuICAgIHN0YXR1czogYXhpb3NSZXNwb25zZS5zdGF0dXMgfHwgbnVsbCxcclxuICAgIGhlYWRlcnM6IGF4aW9zUmVzcG9uc2UuaGVhZGVycyB8fCBudWxsLFxyXG4gICAgY29uZmlnOiBheGlvc1Jlc3BvbnNlLmNvbmZpZyB8fCBudWxsLFxyXG4gICAgZGF0YTogYXhpb3NSZXNwb25zZS5kYXRhIHx8IG51bGxcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gIFdoYXQncyB0aGUgcHJvYmxlbSBmb3IgdGhpcyByZXNwb25zZT9cclxuXHJcbiAgVE9ETzogV2UncmUgbG9zaW5nIHNvbWUgZXJyb3IgZ3JhbnVsYXJpdHksIGJ1dCBpJ20gY29vbCB3aXRoIHRoYXRcclxuICB1bnRpbCBzb21lb25lIGNhcmVzLlxyXG4gKi9cclxuY29uc3QgcmVzcG9uc2VUb1Byb2JsZW0gPSAocmVzcG9uc2UpID0+IHtcclxuICBpZiAocmVzcG9uc2UgaW5zdGFuY2VvZiBFcnJvcikge1xyXG4gICAgcmV0dXJuIFIuY29uZChbXHJcbiAgICAgIFtSLmNvbnRhaW5zKFIuX18sIFRJTUVPVVRfRVJST1JfQ09ERVMpLCBSLmFsd2F5cyhUSU1FT1VUX0VSUk9SKV0sXHJcbiAgICAgIFtSLmNvbnRhaW5zKFIuX18sIE5PREVKU19DT05ORUNUSU9OX0VSUk9SX0NPREVTKSwgUi5hbHdheXMoQ09OTkVDVElPTl9FUlJPUildLFxyXG4gICAgICBbUi5ULCBSLmFsd2F5cyhVTktOT1dOX0VSUk9SKV1cclxuICAgIF0pKHJlc3BvbnNlLmNvZGUpXHJcbiAgfVxyXG4gIGlmIChSLmlzTmlsKHJlc3BvbnNlKSB8fCAhUi5oYXMoJ3N0YXR1cycpKSByZXR1cm4gVU5LTk9XTl9FUlJPUlxyXG4gIHJldHVybiBSLmNvbmQoW1xyXG4gICAgW2luMjAwcywgUi5hbHdheXMoTk9ORSldLFxyXG4gICAgW2luNDAwcywgUi5hbHdheXMoQ0xJRU5UX0VSUk9SKV0sXHJcbiAgICBbaW41MDBzLCBSLmFsd2F5cyhTRVJWRVJfRVJST1IpXSxcclxuICAgIFtSLlQsIFIuYWx3YXlzKFVOS05PV05fRVJST1IpXVxyXG4gIF0pKHJlc3BvbnNlLnN0YXR1cyB8fCAwKVxyXG59XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IHtcclxuICByZXNwb25zZVRvUHJvYmxlbSxcclxuICBjcmVhdGUsXHJcbiAgTk9ORSxcclxuICBDTElFTlRfRVJST1IsXHJcbiAgU0VSVkVSX0VSUk9SLFxyXG4gIFRJTUVPVVRfRVJST1IsXHJcbiAgQ09OTkVDVElPTl9FUlJPUixcclxuICBORVRXT1JLX0VSUk9SLFxyXG4gIFVOS05PV05fRVJST1JcclxufVxuXG5leHBvcnQgeyBOT05FLCBDTElFTlRfRVJST1IsIFNFUlZFUl9FUlJPUiwgVElNRU9VVF9FUlJPUiwgQ09OTkVDVElPTl9FUlJPUiwgTkVUV09SS19FUlJPUiwgVU5LTk9XTl9FUlJPUiwgY3JlYXRlLCByZXNwb25zZVRvUHJvYmxlbSB9OyJdfQ==